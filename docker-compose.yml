services:
  # --- Master server for server discovery ---
  master:
    build:
      context: master
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    command:
      - "--port=8080"
      - "--ttl=30s"
    restart: unless-stopped

  # --- Game server registered with master ---
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    ports:
      - "7373:7373"
    depends_on:
      master:
        condition: service_started
    command:
      - "--port=7373"
      - "--tickrate=20"
      - "--name=Test Server"
      - "--version=0.1.0"
      - "--master=http://master:8080"
      - "--address=localhost:7373"
      - "--maxplayers=4"
    # No restart â€” allows testing TTL expiry by stopping this container

  # Second game server to test browse list with multiple entries
  server-2:
    build:
      context: .
      dockerfile: server/Dockerfile
    ports:
      - "7374:7374"
    depends_on:
      master:
        condition: service_started
    command:
      - "--port=7374"
      - "--tickrate=20"
      - "--name=Open Server"
      - "--master=http://master:8080"
      - "--address=localhost:7374"
      - "--maxplayers=4"
    profiles:
      - testing

  # --- Cross-compilation (existing) ---
  build-linux:
    image: golang:trixie
    working_dir: /app
    volumes:
      - .:/app
      - go-cache:/go/pkg/mod
    command: go build -o dist/linux/doomerang .
    environment:
      - GOOS=linux
      - GOARCH=amd64
    profiles:
      - build

volumes:
  go-cache:
